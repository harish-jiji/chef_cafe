<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chef Cafe ‚Äì Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Dashboard & Nav Styles */
        .admin-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: #f3f4f6;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .dashboard-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .dash-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
        }

        .dash-card h3 {
            margin-bottom: 16px;
            font-size: 18px;
            color: #1a1a1a;
            font-weight: 600;
        }

        #todaySoldList {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        #todaySoldList li {
            border-bottom: 1px solid #f0f0f0;
        }

        #todaySoldList li:last-child {
            border-bottom: none;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Box Styles */
        #loginBox {
            max-width: 420px;
            margin: 80px auto;
            background: #fff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
        }

        #loginBox h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #1a1a1a;
            font-weight: 700;
        }

        #loginBox p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        #loginBox input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        #loginBox input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #loginBox button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #loginBox button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        #loginBox button:active {
            transform: translateY(0);
        }

        /* Billing & Bills Styles */
        .bill-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
            margin-bottom: 20px;
        }

        .bill-card h3 {
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .bill-grid {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr 2fr 1fr auto;
            align-items: end;
            margin-bottom: 20px;
        }

        #billList {
            list-style: none;
            margin: 20px 0;
            border-top: 2px dashed #eee;
            border-bottom: 2px dashed #eee;
            padding: 10px 0;
        }

        #billList li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
        }

        #payBill {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            width: 100%;
            margin-top: 10px;
        }

        /* Bills History Styles */
        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bill-info h4 {
            margin-bottom: 4px;
            color: #333;
        }

        .bill-meta {
            font-size: 13px;
            color: #666;
        }

        .print-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
        }

        .print-btn:hover {
            background: #e5e7eb;
        }

        @media (max-width: 768px) {
            .bill-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Admin Dashboard */
        .admin-wrapper {
            max-width: 1200px;
            margin: auto;
        }

        .admin-header {
            background: #fff;
            padding: 24px 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .15);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h1 {
            font-size: 28px;
            color: #1a1a1a;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-left p {
            color: #666;
            font-size: 14px;
        }

        .header-right button {
            padding: 12px 24px;
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .header-right button:hover {
            background: #fff;
            border-color: #667eea;
            color: #667eea;
        }

        /* Add Item Card */
        .add-item-card {
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .15);
            margin-bottom: 24px;
        }

        .add-item-card h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a1a1a;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-item-card button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-item-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* Items List */
        .items-section h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .items-list {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .menu-card {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
            transition: all 0.3s ease;
        }

        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
        }

        .menu-card h3 {
            font-size: 18px;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .menu-price {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .menu-meta {
            display: inline-block;
            font-size: 12px;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 20px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }

        .card-actions button {
            padding: 10px;
            font-size: 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #f0f0f0;
            color: #333;
        }

        .edit-btn:hover {
            background: #667eea;
            color: #fff;
        }

        .delete-btn {
            background: #fee;
            color: #ef4444;
        }

        .delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* Edit Mode */
        .edit-mode input {
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .edit-mode input:focus {
            outline: none;
            border-color: #667eea;
        }

        .save-btn {
            background: #667eea !important;
            color: #fff !important;
        }

        .save-btn:hover {
            background: #5568d3 !important;
        }

        .cancel-btn {
            background: #e0e0e0 !important;
            color: #333 !important;
        }

        .cancel-btn:hover {
            background: #d0d0d0 !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
        }

        .empty-state h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 2fr 1fr 1fr;
            }

            .add-item-card button {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 767px) {
            body {
                padding: 12px;
            }

            #loginBox {
                margin: 40px auto;
                padding: 30px 24px;
            }

            .admin-header {
                padding: 20px;
            }

            .header-left h1 {
                font-size: 24px;
            }

            .add-item-card {
                padding: 20px;
            }

            .items-list {
                grid-template-columns: 1fr;
            }
        }

        /* Category Grouping Styles */
        .category-block {
            margin-bottom: 50px;
        }

        .category-heading {
            text-align: center;
            font-size: 26px;
            font-weight: 800;
            color: #ffffff;
            margin: 40px 0 25px;
            letter-spacing: 1px;
            position: relative;
        }

        /* Optional underline divider */
        .category-heading::after {
            content: "";
            display: block;
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            margin: 12px auto 0;
            border-radius: 4px;
        }

        .category-items {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .empty-category {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 18px;
            border-radius: 14px;
            color: #fff;
            font-size: 15px;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="loginBox">
        <h2>üçΩÔ∏è Admin Login</h2>
        <p>Welcome back! Please login to continue.</p>

        <div class="input-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>

        <div class="input-group">
            <label for="password">Password</label>
            <div style="position:relative">
                <input type="password" id="password" placeholder="Enter your password">
                <span id="togglePassword" style="
                  position:absolute;
                  right:14px;
                  top:50%;
                  transform:translateY(-50%);
                  cursor:pointer;
                  font-size:14px;
                  color:#667eea;
                  user-select:none;
                ">
                    üëÅ Show
                </span>
            </div>
        </div>

        <button id="loginBtn">Login to Dashboard</button>
    </div>

    <!-- DASHBOARD -->
    <div id="adminPanel" class="admin-wrapper" style="display:none">

        <header class="admin-header">
            <div class="header-left">
                <h1>üçΩÔ∏è Chef Cafe Dashboard</h1>
                <p>Manage your business efficiently</p>
            </div>
            <div class="header-right">
                <button id="logoutBtn">Logout</button>
            </div>
        </header>

        <!-- NAVIGATION -->
        <nav class="admin-nav">
            <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
            <button class="nav-btn" data-page="menu">üçΩÔ∏è Menu</button>
            <button class="nav-btn" data-page="billing">üßæ Billing</button>
            <button class="nav-btn" data-page="bills">üìÇ Bills</button>
        </nav>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard">
            <div class="dash-grid">
                <div class="dash-card">
                    <h3>Bills Today</h3>
                    <p id="billsToday">0</p>
                </div>

                <div class="dash-card">
                    <h3>Items Sold Today</h3>
                    <p id="itemsToday">0</p>
                </div>
            </div>

            <h3 style="margin-top:20px">Top Items Today</h3>
            <div id="topItems"></div>

            <h3 style="margin-top:20px">Last 7 Days Activity</h3>
            <canvas id="activityChart" height="120"></canvas>
        </section>

        <!-- MENU SECTION -->
        <section id="menu" style="display:none">

            <section class="add-item-card">
                <h3>‚ûï Add New Menu Item</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">Item Name</label>
                        <input id="name" placeholder="e.g., Chicken Biryani">
                    </div>

                    <div class="form-group">
                        <label for="price">Price</label>
                        <input id="price" type="text" placeholder="‚Çπ100 / As Per Size">
                    </div>

                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category">
                            <option value="soup">Soup</option>
                            <option value="salads">Salads</option>
                            <option value="starter">Starter</option>
                            <option value="maincourses">Main Courses</option>
                            <option value="chefspecial">Chef Special</option>
                            <option value="asianmain">Asian Main Courses</option>
                            <option value="asiannonveg">Asian Non Veg</option>
                            <option value="asianveg">Asian Veg</option>
                            <option value="kerala">Kerala Style</option>
                            <option value="bread">Bread</option>
                            <option value="grill">Grill Items</option>
                            <option value="crispy">Crispy Bookzz</option>
                            <option value="beverages">Beverages</option>
                            <option value="cafespecials">Cafe Specials</option>
                        </select>
                    </div>
                </div>

                <button id="addItemBtn">Add Item to Menu</button>
            </section>

            <section class="items-section">
                <h3>üìã Menu Items</h3>
                <div class="items-list" id="items">
                    <!-- Items rendered here -->
                </div>
            </section>
        </section>

        <!-- BILLING SECTION -->
        <section id="billing" style="display:none">
            <h2>üßæ Billing</h2>

            <div class="billing-top" style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
                <label>Table No</label>
                <input type="number" id="tableNoInput" min="1" placeholder="Enter table number"
                    style="padding:10px; border-radius:8px; border:1px solid #ccc;">
                <button id="startBillingBtn"
                    style="padding:10px 20px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer;">Start
                    Billing</button>
            </div>

            <div class="billing-body" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <!-- Left: Menu Grid -->
                <div>
                    <h3>Menu</h3>
                    <div class="menu-list" id="billingMenu"
                        style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:10px; max-height:500px; overflow-y:auto;">
                    </div>
                </div>

                <!-- Right: Bill Preview -->
                <div class="bill-preview"
                    style="background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.1);">
                    <h3 id="billTitle">No Bill</h3>
                    <div id="billItems" style="min-height:200px; margin:20px 0;"></div>
                    <hr>
                    <h3>Total: ‚Çπ<span id="billTotal">0</span></h3>
                    <button id="printBtn" disabled
                        style="width:100%; padding:15px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; margin-top:20px;">Print
                        Bill</button>
                </div>
            </div>
        </section>

        <!-- BILLS HISTORY SECTION -->
        <section id="bills" style="display:none">
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="filter-btn" data-filter="today" style="padding:8px 16px;">Today</button>
                <button class="filter-btn" data-filter="yesterday" style="padding:8px 16px;">Yesterday</button>
                <button class="filter-btn" data-filter="7days" style="padding:8px 16px;">Last 7 Days</button>
            </div>

            <div id="billsList"></div>
        </section>

    </div>

    <!-- BILL DETAIL MODAL -->
    <div id="billModal" style="
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      z-index:9999;
      align-items:center;
      justify-content:center;
    ">
        <div style="
        background:#fff;
        width:350px;
        max-height:90vh;
        overflow:auto;
        padding:20px;
        border-radius:12px;
        font-family:monospace;
      ">
            <div id="billView"></div>
            <button id="printViewedBillBtn" style="width:100%;margin-top:10px; padding:10px; cursor:pointer;">
                üñ®Ô∏è Print
            </button>
            <button id="closeBillModalBtn" style="width:100%;margin-top:5px; padding:10px; cursor:pointer;">
                ‚ùå Close
            </button>
        </div>
    </div>

    <!-- Firebase v12 Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

        import {
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDoc,
            getDocs,
            setDoc,
            increment,
            onSnapshot,
            query,
            where,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAON6aij8dNGoRlJ1DdLcwMkPZsAGe-SBQ",
            authDomain: "chef-s-cafe.firebaseapp.com",
            projectId: "chef-s-cafe",
            storageBucket: "chef-s-cafe.firebasestorage.app",
            messagingSenderId: "623426909086",
            appId: "1:623426909086:web:b4c16775db67b1485b5c8f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // DOM ELEMENT REFERENCES
        // ============================================
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const addItemBtn = document.getElementById("addItemBtn");
        const adminPanel = document.getElementById("adminPanel");
        const loginBox = document.getElementById("loginBox");
        const itemsDiv = document.getElementById("items");

        // Input fields
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const nameInput = document.getElementById("name");
        const priceInput = document.getElementById("price");
        const categorySelect = document.getElementById("category");

        // Toggle Password Logic
        const togglePassword = document.getElementById("togglePassword");

        if (togglePassword) {
            togglePassword.addEventListener("click", () => {
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    togglePassword.textContent = "üôà Hide";
                } else {
                    passwordInput.type = "password";
                    togglePassword.textContent = "üëÅ Show";
                }
            });
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        /**
         * Show a user-friendly toast notification
         */
        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * Add CSS animations for notifications
         */
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        /**
         * Validate input fields
         */
        function validateInput(value, fieldName) {
            if (!value || value.trim() === '') {
                showNotification(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        /**
         * Clear form inputs
         */
        function clearForm() {
            nameInput.value = '';
            priceInput.value = '';
            categorySelect.selectedIndex = 0;
        }

        /**
         * Show loading state on button
         */
        function setButtonLoading(button, isLoading, originalText) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = originalText;
                button.textContent = '‚è≥ Loading...';
                button.style.opacity = '0.6';
            } else {
                button.disabled = false;
                button.textContent = button.dataset.originalText || originalText;
                button.style.opacity = '1';
            }
        }

        // ============================================
        // EDIT & DELETE FUNCTIONS (Global Scope)
        // ============================================

        /**
         * Enable edit mode for a menu item
         */
        window.enableEdit = (id) => {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.querySelector(".view-mode").style.display = "none";
                card.querySelector(".edit-mode").style.display = "block";

                // Focus on the name input
                const nameInput = card.querySelector(`#name-${id}`);
                if (nameInput) nameInput.focus();
            }
        };

        /**
         * Cancel edit mode and revert to view mode
         */
        window.cancelEdit = (id) => {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.querySelector(".edit-mode").style.display = "none";
                card.querySelector(".view-mode").style.display = "block";
            }
        };

        /**
         * Save edited item to database
         */
        window.saveEdit = async (id) => {
            const nameField = document.getElementById(`name-${id}`);
            const priceField = document.getElementById(`price-${id}`);

            const newName = nameField.value.trim();
            const newPrice = priceField.value.trim();

            // Validate inputs
            if (!newName) {
                showNotification('Item name cannot be empty', 'error');
                nameField.focus();
                return;
            }

            if (!newPrice) {
                showNotification('Price cannot be empty', 'error');
                priceField.focus();
                return;
            }

            try {
                // Update in Firestore
                await updateDoc(doc(db, "menu_items", id), {
                    name: newName,
                    price: newPrice,
                    updatedAt: new Date().toISOString()
                });

                showNotification('‚úÖ Item updated successfully!', 'success');

                // Return to view mode
                window.cancelEdit(id);
            } catch (err) {
                console.error('Update error:', err);
                showNotification('Failed to update item: ' + err.message, 'error');
            }
        };

        /**
         * Delete item from database with confirmation
         */
        window.deleteItem = async (id) => {
            // Custom confirmation dialog
            const confirmed = confirm("‚ö†Ô∏è Are you sure you want to delete this item?\n\nThis action cannot be undone.");

            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "menu_items", id));
                    showNotification('üóëÔ∏è Item deleted successfully', 'success');
                } catch (err) {
                    console.error('Delete error:', err);
                    showNotification('Failed to delete item: ' + err.message, 'error');
                }
            }
        };

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        /**
         * Format category name for display
         */
        function formatCategory(category) {
            const categoryMap = {
                'soup': 'Soup',
                'salads': 'Salads',
                'starter': 'Starter',
                'maincourses': 'Main Courses',
                'chefspecial': 'Chef Special',
                'asianmain': 'Asian Main',
                'asiannonveg': 'Asian Non-Veg',
                'asianveg': 'Asian Veg',
                'kerala': 'Kerala Style',
                'bread': 'Bread',
                'grill': 'Grill Items',
                'crispy': 'Crispy Bookzz',
                'beverages': 'Beverages',
                'cafespecials': 'Cafe Specials'
            };
            return categoryMap[category] || category;
        }

        const CATEGORY_ORDER = [
            "soup",
            "salads",
            "starter",
            "maincourses",
            "chefspecial",
            "asianmain",
            "asiannonveg",
            "asianveg",
            "kerala",
            "bread",
            "grill",
            "crispy",
            "beverages",
            "cafespecials"
        ];

        /**
         * Render a single menu item card
         */
        function renderItem(docSnap) {
            const item = docSnap.data();
            const id = docSnap.id;

            // Escape HTML to prevent XSS
            const escapedName = item.name.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const escapedPrice = item.price.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            return `
        <div class="menu-card" data-id="${id}">
          <div class="view-mode">
            <h3>${escapedName}</h3>
            <div class="menu-price">${escapedPrice}</div>
            <span class="menu-meta">${formatCategory(item.category)}</span>

            <div class="card-actions">
              <button class="edit-btn" onclick="enableEdit('${id}')" title="Edit this item">
                ‚úèÔ∏è Edit
              </button>
              <button class="delete-btn" onclick="deleteItem('${id}')" title="Delete this item">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>

          <div class="edit-mode" style="display:none">
            <input 
              type="text" 
              id="name-${id}" 
              value="${escapedName}" 
              placeholder="Item name"
              aria-label="Item name"
            >
            <input 
              type="text" 
              id="price-${id}" 
              value="${escapedPrice}" 
              placeholder="Price"
              aria-label="Price"
            >

            <div class="card-actions">
              <button class="save-btn" onclick="saveEdit('${id}')" title="Save changes">
                üíæ Save
              </button>
              <button class="cancel-btn" onclick="cancelEdit('${id}')" title="Cancel editing">
                ‚úñÔ∏è Cancel
              </button>
            </div>
          </div>
        </div>
      `;
        }

        /**
         * Render empty state when no items exist
         */
        function renderEmptyState() {
            return `
                <div class="empty-state">
                    <h3>üìã No menu items yet</h3>
                    <p>Add your first item using the form above to get started</p>
                </div>
            `;
        }

        // ============================================
        // AUTHENTICATION HANDLERS
        // ============================================

        /**
         * Handle user login
         */
        if (loginBtn) {
            loginBtn.addEventListener("click", async () => {
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                // Validate inputs
                if (!validateInput(email, 'Email')) return;
                if (!validateInput(password, 'Password')) return;

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showNotification('Please enter a valid email address', 'error');
                    return;
                }

                // Show loading state
                setButtonLoading(loginBtn, true, 'Login to Dashboard');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showNotification('‚úÖ Login successful! Welcome back.', 'success');
                } catch (err) {
                    console.error('Login error:', err);

                    // User-friendly error messages
                    let errorMessage = 'Login failed. Please try again.';

                    if (err.code === 'auth/invalid-credential') {
                        errorMessage = 'Invalid email or password';
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email';
                    } else if (err.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password';
                    } else if (err.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed attempts. Please try again later';
                    } else if (err.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Check your connection';
                    }

                    showNotification(errorMessage, 'error');
                } finally {
                    setButtonLoading(loginBtn, false, 'Login to Dashboard');
                }
            });

            // Allow Enter key to submit login
            [emailInput, passwordInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });
            });
        }

        /**
         * Handle user logout
         */
        if (logoutBtn) {
            logoutBtn.addEventListener("click", async () => {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await signOut(auth);
                        showNotification('üëã Logged out successfully', 'success');

                        // Clear input fields
                        emailInput.value = '';
                        passwordInput.value = '';
                    } catch (err) {
                        console.error("Logout error:", err);
                        showNotification('Logout failed. Please try again.', 'error');
                    }
                }
            });
        }

        // ============================================
        // ADD ITEM HANDLER
        // ============================================

        /**
         * Handle adding new menu item
         */
        if (addItemBtn) {
            addItemBtn.addEventListener("click", async () => {
                const name = nameInput.value.trim();
                const price = priceInput.value.trim();
                const category = categorySelect.value;

                // Validate inputs
                if (!validateInput(name, 'Item name')) {
                    nameInput.focus();
                    return;
                }

                if (!validateInput(price, 'Price')) {
                    priceInput.focus();
                    return;
                }

                // Show loading state
                setButtonLoading(addItemBtn, true, 'Add Item to Menu');

                try {
                    // Add item to Firestore with timestamp
                    await addDoc(collection(db, "menu_items"), {
                        name,
                        price,
                        category,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });

                    // Clear form
                    clearForm();

                    // Show success message
                    showNotification('‚úÖ Item added successfully!', 'success');

                    // Scroll to items section on mobile
                    if (window.innerWidth < 768) {
                        document.querySelector('.items-section').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                } catch (error) {
                    console.error("Error adding item:", error);

                    // User-friendly error message
                    let errorMessage = 'Failed to add item. Please try again.';

                    if (error.code === 'permission-denied') {
                        errorMessage = 'Permission denied. Please check your access rights.';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'Service unavailable. Check your connection.';
                    }

                    showNotification(errorMessage, 'error');
                } finally {
                    setButtonLoading(addItemBtn, false, 'Add Item to Menu');
                }
            });

            // Allow Enter key in name and price fields to add item
            [nameInput, priceInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addItemBtn.click();
                    }
                });
            });
        }

        // ============================================
        // AUTHENTICATION STATE MANAGEMENT
        // ============================================

        /**
         * Monitor authentication state changes
         * Shows/hides appropriate UI based on login status
         */
        onAuthStateChanged(auth, user => {
            if (user) {
                // Logged in
                loginBox.style.display = "none";
                adminPanel.style.display = "block";

                // Load initial data
                loadItems();            // Existing Menu Items
                loadDashboardGraph();   // Dashboard
                loadTodaySoldItems();   // Dashboard
                loadBillingItems();     // Billing Dropdown
                loadBills('7days');     // Bills History

                // Show default page
                showPage('dashboard');

                console.log('‚úÖ Logged in:', user.email);
            } else {
                // Logged out
                loginBox.style.display = "block";
                adminPanel.style.display = "none";

                // Clear any sensitive data
                if (itemsDiv) itemsDiv.innerHTML = '';

                console.log('üö™ Logged out');
            }
        });

        // ============================================
        // LOAD ITEMS FROM DATABASE
        // ============================================

        /**
         * Load and display all menu items with real-time updates
         * Items are sorted by creation date (newest first)
         */
        function loadItems() {
            const itemsRef = collection(db, "menu_items");

            onSnapshot(itemsRef, (snapshot) => {

                // 1Ô∏è‚É£ Create empty category buckets
                const grouped = {};
                CATEGORY_ORDER.forEach(cat => grouped[cat] = []);

                // 2Ô∏è‚É£ Push items into their category
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const category = item.category || "others";
                    if (!grouped[category]) grouped[category] = [];
                    grouped[category].push(docSnap);
                });

                // 3Ô∏è‚É£ Render category sections
                itemsDiv.innerHTML = "";

                CATEGORY_ORDER.forEach(category => {
                    const items = grouped[category];

                    itemsDiv.innerHTML += `
              <div class="category-block">
                <h4 class="category-heading">${formatCategory(category)}</h4>
                <div class="category-items">
                  ${items.length
                            ? items.map(renderItem).join("")
                            : `<p class="empty-category">No items in this category</p>`
                        }
                </div>
              </div>
            `;
                });

                console.log("üì¶ Categories rendered");

            }, error => {
                console.error(error);
                showNotification(error.message, "error");
            });
        }

        // ============================================
        // DASHBOARD LOGIC (PHASE 6)
        // ============================================

        function startOfDay(ts) {
            const d = new Date(ts);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        function endOfDay(ts) {
            const d = new Date(ts);
            d.setHours(23, 59, 59, 999);
            return d.getTime();
        }

        async function loadDashboard() {
            const now = Date.now();
            const start = startOfDay(now);
            const end = endOfDay(now);

            // Query only PAID bills for today
            const q = query(
                collection(db, "bills"),
                where("timestamp", ">=", start),
                where("timestamp", "<=", end),
                where("status", "==", "PAID")
            );

            onSnapshot(q, snapshot => {
                let billCount = snapshot.size;
                let totalItemsCount = 0;
                let itemMap = {};

                snapshot.forEach(docSnap => {
                    const bill = docSnap.data();
                    if (bill.items) {
                        bill.items.forEach(i => {
                            totalItemsCount += i.qty;
                            itemMap[i.name] = (itemMap[i.name] || 0) + i.qty;
                        });
                    }
                });

                // Update Widgets
                const billsTodayEl = document.getElementById("billsToday");
                const itemsTodayEl = document.getElementById("itemsToday");

                if (billsTodayEl) billsTodayEl.innerText = billCount;
                if (itemsTodayEl) itemsTodayEl.innerText = totalItemsCount;

                // Top Items
                const topItemsDiv = document.getElementById("topItems");
                if (topItemsDiv) {
                    topItemsDiv.innerHTML = "";
                    Object.entries(itemMap)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .forEach(([name, qty]) => {
                            topItemsDiv.innerHTML += `
                                <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                                    <span>${name}</span>
                                    <strong>${qty}</strong>
                                </div>
                            `;
                        });
                }
            });
        }

        async function loadActivityChart() {
            const ctx = document.getElementById("activityChart");
            if (!ctx) return;

            const labels = [];
            const data = [];

            // Last 7 days loop
            for (let i = 6; i >= 0; i--) {
                const day = Date.now() - (i * 86400000);
                const s = startOfDay(day);
                const e = endOfDay(day);

                const q = query(
                    collection(db, "bills"),
                    where("timestamp", ">=", s),
                    where("timestamp", "<=", e),
                    where("status", "==", "PAID")
                );

                const snap = await getDocs(q);

                labels.push(new Date(day).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }));
                data.push(snap.size);
            }

            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Bills Paid",
                        data,
                        borderColor: "#667eea",
                        backgroundColor: "rgba(102,126,234,0.15)",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // ============================================
        // NAVIGATION LOGIC (PHASE 3-D)
        // ============================================

        const pages = ["dashboard", "menu", "billing", "bills"];
        const navButtons = document.querySelectorAll(".nav-btn");

        function showPage(page) {
            pages.forEach(p => {
                const el = document.getElementById(p);
                if (el) el.style.display = p === page ? "block" : "none";
            });

            navButtons.forEach(btn => {
                btn.classList.toggle("active", btn.dataset.page === page);
            });

            // Trigger data loads
            if (page === "dashboard") {
                loadDashboard();
                loadActivityChart();
            }
            if (page === "bills") {
                loadBills("7days");
            }
        }

        navButtons.forEach(btn => {
            btn.onclick = () => showPage(btn.dataset.page);
        });

        // ============================================
        // BILLING LOGIC (PHASES 4.2 & 4.3)
        // ============================================

        let currentBill = null;
        let currentBillId = null;

        // Bill Number Generator (B-YYYYMMDD-XXX)
        async function generateBillNo() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}${mm}${dd}`; // 20260121

            const start = startOfDay(Date.now());
            const end = endOfDay(Date.now());

            // Count bills today to generate next sequence
            const q = query(collection(db, "bills"), where("timestamp", ">=", start), where("timestamp", "<=", end));
            const snap = await getDocs(q);
            const count = snap.size + 1;

            const suffix = String(count).padStart(3, '0');
            return `B-${dateStr}-${suffix}`;
        }

        // 1. Start Billing (Lock Table)
        window.startBilling = async () => {
            const tableNoInput = document.getElementById("tableNoInput");
            const tableNo = Number(tableNoInput.value);
            const btn = document.getElementById("startBillingBtn");

            if (!tableNo) {
                showNotification("Please enter a table number", "error");
                return;
            }

            setButtonLoading(btn, true, "Start Billing");

            try {
                // Check for existing OPEN bill
                const q = query(
                    collection(db, "bills"),
                    where("tableNo", "==", tableNo),
                    where("status", "==", "OPEN")
                );

                const snap = await getDocs(q);

                if (!snap.empty) {
                    // Resume existing bill
                    const docSnap = snap.docs[0];
                    currentBill = docSnap.data();
                    currentBillId = docSnap.id;
                    showNotification(`Found open bill for Table ${tableNo}`, "success");
                } else {
                    // Create new bill
                    const billNo = await generateBillNo();
                    const newBill = {
                        billNo,
                        tableNo,
                        items: [],
                        total: 0,
                        status: "OPEN",
                        date: new Date().toISOString().split("T")[0],
                        timestamp: Date.now()
                    };

                    const docRef = await addDoc(collection(db, "bills"), newBill);
                    currentBill = newBill;
                    currentBillId = docRef.id;
                    showNotification(`Started new bill ${billNo}`, "success");
                }

                renderBill();
                loadBillingMenu();

                // Update UI
                document.getElementById("printBtn").disabled = false;

            } catch (e) {
                console.error(e);
                showNotification("Error starting bill: " + e.message, "error");
            } finally {
                setButtonLoading(btn, false, "Start Billing");
            }
        };

        // 2. Load Menu for Billing (Grid)
        function loadBillingMenu() {
            onSnapshot(collection(db, "menu_items"), snap => {
                const div = document.getElementById("billingMenu");
                if (!div) return;
                div.innerHTML = "";

                snap.forEach(d => {
                    const item = d.data();
                    // Clean price for display
                    const priceDisplay = isNaN(item.price) ? item.price : `‚Çπ${item.price}`;

                    div.innerHTML += `
                    <button onclick="addItem('${item.name}', '${item.price}')" 
                        style="
                            padding:15px; 
                            background:#f9fafb; 
                            border:1px solid #e5e7eb; 
                            border-radius:10px; 
                            cursor:pointer;
                            text-align:center;
                            transition:all 0.2s;
                        "
                        onmouseover="this.style.background='#edf2f7'"
                        onmouseout="this.style.background='#f9fafb'"
                    >
                        <div style="font-weight:600; margin-bottom:5px;">${item.name}</div>
                        <div style="color:#667eea; font-size:13px;">${priceDisplay}</div>
                    </button>
                    `;
                });
            });
        }

        // 3. Add Item to Bill
        window.addItem = (name, priceText) => {
            if (!currentBill) {
                showNotification("Please start billing first", "error");
                return;
            }

            // Find if item exists in bill
            let item = currentBill.items.find(i => i.name === name);

            if (item) {
                item.qty += 1;
            } else {
                currentBill.items.push({ name, qty: 1, priceText });
            }

            calculateTotal();
            saveBill();
            renderBill();
        };

        // 4. Calculate Total
        function calculateTotal() {
            let total = 0;
            currentBill.items.forEach(i => {
                const num = parseFloat(i.priceText); // simple parse
                if (!isNaN(num)) total += num * i.qty;
            });
            currentBill.total = total;
        }

        // 5. Save Bill (Sync)
        async function saveBill() {
            if (!currentBillId) return;
            try {
                await updateDoc(doc(db, "bills", currentBillId), {
                    items: currentBill.items,
                    total: currentBill.total
                });
            } catch (e) {
                console.error("Auto-save failed", e);
            }
        }

        // 6. Render Bill Preview
        function renderBill() {
            const billTitle = document.getElementById("billTitle");
            const billItems = document.getElementById("billItems");
            const billTotal = document.getElementById("billTotal");

            if (currentBill) {
                billTitle.innerText = `Bill ${currentBill.billNo} (Table ${currentBill.tableNo})`;
                billTotal.innerText = currentBill.total;

                billItems.innerHTML = "";
                currentBill.items.forEach((item, index) => {
                    billItems.innerHTML += `
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
                            <span>${item.name} <small>x${item.qty}</small></span>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span>‚Çπ${(parseFloat(item.priceText) || 0) * item.qty}</span>
                                <button onclick="window.decreaseQty(${index})" style="background:#fee2e2; color:#ef4444; border:none; width:24px; height:24px; border-radius:4px; cursor:pointer;">-</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                billTitle.innerText = "No Bill";
                billItems.innerHTML = "<p style='color:#999; text-align:center; padding-top:20px'>Select a table to start</p>";
                billTotal.innerText = "0";
            }
        }

        // Helper: Decrease Qty
        window.decreaseQty = (index) => {
            if (!currentBill) return;

            const item = currentBill.items[index];
            if (item.qty > 1) {
                item.qty -= 1;
            } else {
                currentBill.items.splice(index, 1);
            }

            calculateTotal();
            saveBill();
            renderBill();
        }

        // 7. Finalize & Print
        window.finalizeBill = async () => {
            if (!currentBill || currentBill.items.length === 0) {
                showNotification("Bill is empty", "error");
                return;
            }

            if (!confirm("Confirm payment and print bill?")) return;

            const btn = document.getElementById("printBtn");
            setButtonLoading(btn, true, "Print Bill");

            try {
                await updateDoc(doc(db, "bills", currentBillId), {
                    status: "PAID",
                    paidAt: Date.now()
                });

                printBill();

                // Reset
                currentBill = null;
                currentBillId = null;
                document.getElementById("tableNoInput").value = "";
                document.getElementById("printBtn").disabled = true;
                renderBill();

                showNotification("Bill Paid & Printed", "success");

            } catch (e) {
                console.error(e);
                showNotification("Error finalizing bill", "error");
            } finally {
                setButtonLoading(btn, false, "Print Bill");
            }
        };

        // 8. Print Logic
        function printBill() {
            if (!currentBill) return;

            let rows = "";
            currentBill.items.forEach(i => {
                rows += `
                  <tr>
                    <td>${i.name}</td>
                    <td>${i.qty}</td>
                    <td>${(parseFloat(i.priceText) || 0) * i.qty}</td>
                  </tr>
                `;
            });

            const win = window.open("", "PRINT", "height=600,width=400");

            win.document.write(`
                <html>
                  <head>
                    <title>Bill ${currentBill.billNo}</title>
                    <style>
                      body { font-family: monospace; padding: 10px; }
                      h2, h3 { text-align: center; margin: 5px 0; }
                      table { width: 100%; border-collapse: collapse; margin-top:10px; }
                      td, th { text-align: left; padding: 5px 0; }
                      hr { border-top: 1px dashed #000; margin: 10px 0; }
                    </style>
                  </head>
                  <body>
                    <h2>Chef Cafe</h2>
                    <p style="text-align:center">Tasty & Spicy</p>
                    <hr>
                    <p>Bill: ${currentBill.billNo}</p>
                    <p>Table: ${currentBill.tableNo}</p>
                    <p>Date: ${new Date().toLocaleString()}</p>
                    <hr>
                    <table>
                      <tr><th>Item</th><th>Qty</th><th>Amt</th></tr>
                      ${rows}
                    </table>
                    <hr>
                    <h3>Total: ‚Çπ${currentBill.total}</h3>
                    <p style="text-align:center; margin-top:20px;">Thank You! Visit Again üôè</p>
                  </body>
                </html>
            `);

            win.document.close();
            win.focus();
            setTimeout(() => {
                win.print();
                win.close();
            }, 500);
        }


        // ============================================
        // BILLS HISTORY (PHASE 5)
        // ============================================

        window.loadBills = (filterType) => {
            const billsList = document.getElementById("billsList");
            if (!billsList) return;

            billsList.innerHTML = "<p style='text-align:center; padding:20px'>Loading bills...</p>";

            const now = Date.now();
            let start, end;

            if (filterType === "today") {
                start = startOfDay(now);
                end = endOfDay(now);
            } else if (filterType === "yesterday") {
                const y = now - 86400000;
                start = startOfDay(y);
                end = endOfDay(y);
            } else { // 7days
                start = now - (7 * 86400000);
                end = now;
            }

            const q = query(
                collection(db, "bills"),
                where("timestamp", ">=", start),
                where("timestamp", "<=", end),
                orderBy("timestamp", "desc")
            );

            onSnapshot(q, snapshot => {
                if (snapshot.empty) {
                    billsList.innerHTML = "<div class='empty-state'><p>No bills found for this period</p></div>";
                    return;
                }

                billsList.innerHTML = "";

                snapshot.forEach(docSnap => {
                    const b = docSnap.data();
                    const totalQty = b.items ? b.items.reduce((acc, i) => acc + i.qty, 0) : 0;

                    billsList.innerHTML += `
                        <div class="history-card" onclick="openBill('${docSnap.id}')" style="cursor:pointer">
                            <div class="bill-info">
                                <h4>${b.billNo}</h4>
                                <div class="bill-meta">
                                    Table ${b.tableNo} ‚Ä¢ ${b.date}
                                </div>
                            </div>
                            <div class="bill-actions">
                                <span style="margin-right:15px; font-weight:600">‚Çπ${b.total}</span>
                                <span class="status-tag" style="
                                    background:${b.status === 'PAID' ? '#d1fae5' : '#fee2e2'}; 
                                    color:${b.status === 'PAID' ? '#047857' : '#b91c1c'}; 
                                    padding:4px 8px; 
                                    border-radius:4px; 
                                    font-size:12px;
                                ">${b.status}</span>
                            </div>
                        </div>
                    `;
                });
            });

            // Update active buttons
            document.querySelectorAll(".filter-btn").forEach(btn => {
                btn.style.background = btn.dataset.filter === filterType ? "#667eea" : "#f3f4f6";
                btn.style.color = btn.dataset.filter === filterType ? "white" : "#333";
            });
        };

        // Filter Buttons Handler
        document.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener('click', () => {
                loadBills(btn.dataset.filter);
            });
        });

        // ============================================
        // BILL DETAIL VIEW (PHASE 7)
        // ============================================

        let viewedBill = null;

        window.openBill = async (id) => {
            try {
                const snap = await getDoc(doc(db, "bills", id));
                if (!snap.exists()) return;

                viewedBill = snap.data();

                let rows = "";
                viewedBill.items.forEach(i => {
                    rows += `
                      <tr>
                        <td>${i.name}</td>
                        <td style="text-align:right">${i.qty}</td>
                      </tr>
                    `;
                });

                document.getElementById("billView").innerHTML = `
                    <h3 style="text-align:center">Chef Cafe</h3>
                    <p>Bill: ${viewedBill.billNo}</p>
                    <p>Table: ${viewedBill.tableNo}</p>
                    <p>Date: ${new Date(viewedBill.timestamp).toLocaleString()}</p>
                    <hr>
                    <table width="100%">
                      ${rows}
                    </table>
                    <hr>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px">
                        <span>Total:</span>
                        <span>‚Çπ${viewedBill.total}</span>
                    </div>
                `;

                document.getElementById("billModal").style.display = "flex";
            } catch (e) {
                console.error(e);
                showNotification("Error loading bill details", "error");
            }
        };

        document.getElementById("closeBillModalBtn").onclick = () => {
            document.getElementById("billModal").style.display = "none";
        };

        document.getElementById("printViewedBillBtn").onclick = () => {
            if (!viewedBill) return;

            let rows = "";
            viewedBill.items.forEach(i => {
                rows += `
                  <tr>
                    <td>${i.name}</td>
                    <td>${i.qty}</td>
                  </tr>
                `;
            });

            const win = window.open("", "PRINT", "width=400,height=600");

            win.document.write(`
                <html>
                  <body style="font-family:monospace;padding:10px">
                    <h3 style="text-align:center">Chef Cafe</h3>
                    <p>Bill: ${viewedBill.billNo}</p>
                    <p>Table: ${viewedBill.tableNo}</p>
                    <p>${new Date(viewedBill.timestamp).toLocaleString()}</p>
                    <hr>
                    <table width="100%">
                      <tr><th>Item</th><th>Qty</th></tr>
                      ${rows}
                    </table>
                    <hr>
                    <h3>Total: ‚Çπ${viewedBill.total}</h3>
                    <p style="text-align:center">Copy (Re-Print)</p>
                  </body>
                </html>
              `);

            win.document.close();
            win.focus();
            win.print();
            win.close();
        };
    </script>
</body>

</html>