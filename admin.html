<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chef Cafe ‚Äì Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Dashboard & Nav Styles */
        .admin-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: #f3f4f6;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .dashboard-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .dash-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
        }

        .dash-card h3 {
            margin-bottom: 16px;
            font-size: 18px;
            color: #1a1a1a;
            font-weight: 600;
        }

        #todaySoldList {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        #todaySoldList li {
            border-bottom: 1px solid #f0f0f0;
        }

        #todaySoldList li:last-child {
            border-bottom: none;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Box Styles */
        #loginBox {
            max-width: 420px;
            margin: 80px auto;
            background: #fff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
        }

        #loginBox h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #1a1a1a;
            font-weight: 700;
        }

        #loginBox p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        #loginBox input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        #loginBox input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #loginBox button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #loginBox button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        #loginBox button:active {
            transform: translateY(0);
        }

        /* Billing & Bills Styles */
        .bill-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
            margin-bottom: 20px;
        }

        .bill-card h3 {
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .bill-grid {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr 2fr 1fr auto;
            align-items: end;
            margin-bottom: 20px;
        }

        #billList {
            list-style: none;
            margin: 20px 0;
            border-top: 2px dashed #eee;
            border-bottom: 2px dashed #eee;
            padding: 10px 0;
        }

        #billList li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
        }

        #payBill {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            width: 100%;
            margin-top: 10px;
        }

        /* Bills History Styles */
        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bill-info h4 {
            margin-bottom: 4px;
            color: #333;
        }

        .bill-meta {
            font-size: 13px;
            color: #666;
        }

        .print-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
        }

        .print-btn:hover {
            background: #e5e7eb;
        }

        @media (max-width: 768px) {
            .bill-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Admin Dashboard */
        .admin-wrapper {
            max-width: 1200px;
            margin: auto;
        }

        .admin-header {
            background: #fff;
            padding: 24px 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .15);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h1 {
            font-size: 28px;
            color: #1a1a1a;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-left p {
            color: #666;
            font-size: 14px;
        }

        .header-right button {
            padding: 12px 24px;
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .header-right button:hover {
            background: #fff;
            border-color: #667eea;
            color: #667eea;
        }

        /* Add Item Card */
        .add-item-card {
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .15);
            margin-bottom: 24px;
        }

        .add-item-card h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1a1a1a;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-item-card button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-item-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* Items List */
        .items-section h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .items-list {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .menu-card {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
            transition: all 0.3s ease;
        }

        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
        }

        .menu-card h3 {
            font-size: 18px;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .menu-price {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .menu-meta {
            display: inline-block;
            font-size: 12px;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 20px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }

        .card-actions button {
            padding: 10px;
            font-size: 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #f0f0f0;
            color: #333;
        }

        .edit-btn:hover {
            background: #667eea;
            color: #fff;
        }

        .delete-btn {
            background: #fee;
            color: #ef4444;
        }

        .delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* Edit Mode */
        .edit-mode input {
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .edit-mode input:focus {
            outline: none;
            border-color: #667eea;
        }

        .save-btn {
            background: #667eea !important;
            color: #fff !important;
        }

        .save-btn:hover {
            background: #5568d3 !important;
        }

        .cancel-btn {
            background: #e0e0e0 !important;
            color: #333 !important;
        }

        .cancel-btn:hover {
            background: #d0d0d0 !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
        }

        .empty-state h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 2fr 1fr 1fr;
            }

            .add-item-card button {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 767px) {
            body {
                padding: 12px;
            }

            #loginBox {
                margin: 40px auto;
                padding: 30px 24px;
            }

            .admin-header {
                padding: 20px;
            }

            .header-left h1 {
                font-size: 24px;
            }

            .add-item-card {
                padding: 20px;
            }

            .items-list {
                grid-template-columns: 1fr;
            }
        }

        /* Category Grouping Styles */
        .category-block {
            margin-bottom: 50px;
        }

        .category-heading {
            text-align: center;
            font-size: 26px;
            font-weight: 800;
            color: #ffffff;
            margin: 40px 0 25px;
            letter-spacing: 1px;
            position: relative;
        }

        /* Optional underline divider */
        .category-heading::after {
            content: "";
            display: block;
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            margin: 12px auto 0;
            border-radius: 4px;
        }

        .category-items {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .empty-category {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 18px;
            border-radius: 14px;
            color: #fff;
            font-size: 15px;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="loginBox">
        <h2>üçΩÔ∏è Admin Login</h2>
        <p>Welcome back! Please login to continue.</p>

        <div class="input-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>

        <div class="input-group">
            <label for="password">Password</label>
            <div style="position:relative">
                <input type="password" id="password" placeholder="Enter your password">
                <span id="togglePassword" style="
                  position:absolute;
                  right:14px;
                  top:50%;
                  transform:translateY(-50%);
                  cursor:pointer;
                  font-size:14px;
                  color:#667eea;
                  user-select:none;
                ">
                    üëÅ Show
                </span>
            </div>
        </div>

        <button id="loginBtn">Login to Dashboard</button>
    </div>

    <!-- DASHBOARD -->
    <div id="adminPanel" class="admin-wrapper" style="display:none">

        <header class="admin-header">
            <div class="header-left">
                <h1>üçΩÔ∏è Chef Cafe Dashboard</h1>
                <p>Manage your business efficiently</p>
            </div>
            <div class="header-right">
                <button id="logoutBtn">Logout</button>
            </div>
        </header>

        <!-- NAVIGATION -->
        <nav class="admin-nav">
            <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
            <button class="nav-btn" data-page="menu">üçΩÔ∏è Menu</button>
            <button class="nav-btn" data-page="billing">üßæ Billing</button>
            <button class="nav-btn" data-page="bills">üìÇ Bills</button>
        </nav>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard">
            <div class="dashboard-grid">
                <!-- GRAPH CARD -->
                <div class="dash-card">
                    <h3>üìà Activity (Last 7 Days)</h3>
                    <canvas id="activityChart" height="200"></canvas>
                </div>

                <!-- TODAY SOLD -->
                <div class="dash-card">
                    <h3>üßæ Today Sold Items</h3>
                    <ul id="todaySoldList">
                        <li style="text-align:center; color:#999; padding:20px;">Loading...</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- MENU SECTION -->
        <section id="menu" style="display:none">

            <section class="add-item-card">
                <h3>‚ûï Add New Menu Item</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">Item Name</label>
                        <input id="name" placeholder="e.g., Chicken Biryani">
                    </div>

                    <div class="form-group">
                        <label for="price">Price</label>
                        <input id="price" type="text" placeholder="‚Çπ100 / As Per Size">
                    </div>

                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category">
                            <option value="soup">Soup</option>
                            <option value="salads">Salads</option>
                            <option value="starter">Starter</option>
                            <option value="maincourses">Main Courses</option>
                            <option value="chefspecial">Chef Special</option>
                            <option value="asianmain">Asian Main Courses</option>
                            <option value="asiannonveg">Asian Non Veg</option>
                            <option value="asianveg">Asian Veg</option>
                            <option value="kerala">Kerala Style</option>
                            <option value="bread">Bread</option>
                            <option value="grill">Grill Items</option>
                            <option value="crispy">Crispy Bookzz</option>
                            <option value="beverages">Beverages</option>
                            <option value="cafespecials">Cafe Specials</option>
                        </select>
                    </div>
                </div>

                <button id="addItemBtn">Add Item to Menu</button>
            </section>

            <section class="items-section">
                <h3>üìã Menu Items</h3>
                <div class="items-list" id="items">
                    <!-- Items rendered here -->
                </div>
            </section>
        </section>

        <!-- BILLING SECTION -->
        <section id="billing" style="display:none">
            <div class="bill-card">
                <h3>üßæ New Bill</h3>

                <div class="form-grid bill-grid">
                    <div class="form-group">
                        <label>Table No</label>
                        <input type="number" id="tableNo" min="1" placeholder="Type..." required>
                    </div>

                    <div class="form-group">
                        <label>Item</label>
                        <select id="billItem"></select>
                    </div>

                    <div class="form-group">
                        <label>Qty</label>
                        <input type="number" id="billQty" min="1" value="1">
                    </div>

                    <button id="addToBill" style="padding:12px; margin-top:0;">‚ûï Add</button>
                </div>

                <ul id="billList">
                    <!-- Bill items go here -->
                </ul>

                <h4 style="text-align:right; margin-bottom:15px; font-size:18px;">Total Items: <span
                        id="totalItems">0</span></h4>

                <button id="payBill">üí≥ PAY & PRINT</button>
            </div>
        </section>

        <!-- BILLS HISTORY SECTION -->
        <section id="bills" style="display:none">
            <div class="bill-header">
                <h3 style="color:#fff">üìÇ Bills History</h3>
                <select id="billFilter" style="padding:8px; border-radius:8px;">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="7days" selected>Last 7 Days</option>
                </select>
            </div>
            <div id="billsList">
                <!-- Bills go here -->
            </div>
        </section>

    </div>

    <!-- Firebase v12 Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

        import {
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDoc,
            setDoc,
            increment,
            onSnapshot,
            query,
            where,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAON6aij8dNGoRlJ1DdLcwMkPZsAGe-SBQ",
            authDomain: "chef-s-cafe.firebaseapp.com",
            projectId: "chef-s-cafe",
            storageBucket: "chef-s-cafe.firebasestorage.app",
            messagingSenderId: "623426909086",
            appId: "1:623426909086:web:b4c16775db67b1485b5c8f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // DOM ELEMENT REFERENCES
        // ============================================
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const addItemBtn = document.getElementById("addItemBtn");
        const adminPanel = document.getElementById("adminPanel");
        const loginBox = document.getElementById("loginBox");
        const itemsDiv = document.getElementById("items");

        // Input fields
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const nameInput = document.getElementById("name");
        const priceInput = document.getElementById("price");
        const categorySelect = document.getElementById("category");

        // Toggle Password Logic
        const togglePassword = document.getElementById("togglePassword");

        if (togglePassword) {
            togglePassword.addEventListener("click", () => {
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    togglePassword.textContent = "üôà Hide";
                } else {
                    passwordInput.type = "password";
                    togglePassword.textContent = "üëÅ Show";
                }
            });
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        /**
         * Show a user-friendly toast notification
         */
        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * Add CSS animations for notifications
         */
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        /**
         * Validate input fields
         */
        function validateInput(value, fieldName) {
            if (!value || value.trim() === '') {
                showNotification(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        /**
         * Clear form inputs
         */
        function clearForm() {
            nameInput.value = '';
            priceInput.value = '';
            categorySelect.selectedIndex = 0;
        }

        /**
         * Show loading state on button
         */
        function setButtonLoading(button, isLoading, originalText) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = originalText;
                button.textContent = '‚è≥ Loading...';
                button.style.opacity = '0.6';
            } else {
                button.disabled = false;
                button.textContent = button.dataset.originalText || originalText;
                button.style.opacity = '1';
            }
        }

        // ============================================
        // EDIT & DELETE FUNCTIONS (Global Scope)
        // ============================================

        /**
         * Enable edit mode for a menu item
         */
        window.enableEdit = (id) => {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.querySelector(".view-mode").style.display = "none";
                card.querySelector(".edit-mode").style.display = "block";

                // Focus on the name input
                const nameInput = card.querySelector(`#name-${id}`);
                if (nameInput) nameInput.focus();
            }
        };

        /**
         * Cancel edit mode and revert to view mode
         */
        window.cancelEdit = (id) => {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.querySelector(".edit-mode").style.display = "none";
                card.querySelector(".view-mode").style.display = "block";
            }
        };

        /**
         * Save edited item to database
         */
        window.saveEdit = async (id) => {
            const nameField = document.getElementById(`name-${id}`);
            const priceField = document.getElementById(`price-${id}`);

            const newName = nameField.value.trim();
            const newPrice = priceField.value.trim();

            // Validate inputs
            if (!newName) {
                showNotification('Item name cannot be empty', 'error');
                nameField.focus();
                return;
            }

            if (!newPrice) {
                showNotification('Price cannot be empty', 'error');
                priceField.focus();
                return;
            }

            try {
                // Update in Firestore
                await updateDoc(doc(db, "menu_items", id), {
                    name: newName,
                    price: newPrice,
                    updatedAt: new Date().toISOString()
                });

                showNotification('‚úÖ Item updated successfully!', 'success');

                // Return to view mode
                window.cancelEdit(id);
            } catch (err) {
                console.error('Update error:', err);
                showNotification('Failed to update item: ' + err.message, 'error');
            }
        };

        /**
         * Delete item from database with confirmation
         */
        window.deleteItem = async (id) => {
            // Custom confirmation dialog
            const confirmed = confirm("‚ö†Ô∏è Are you sure you want to delete this item?\n\nThis action cannot be undone.");

            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "menu_items", id));
                    showNotification('üóëÔ∏è Item deleted successfully', 'success');
                } catch (err) {
                    console.error('Delete error:', err);
                    showNotification('Failed to delete item: ' + err.message, 'error');
                }
            }
        };

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        /**
         * Format category name for display
         */
        function formatCategory(category) {
            const categoryMap = {
                'soup': 'Soup',
                'salads': 'Salads',
                'starter': 'Starter',
                'maincourses': 'Main Courses',
                'chefspecial': 'Chef Special',
                'asianmain': 'Asian Main',
                'asiannonveg': 'Asian Non-Veg',
                'asianveg': 'Asian Veg',
                'kerala': 'Kerala Style',
                'bread': 'Bread',
                'grill': 'Grill Items',
                'crispy': 'Crispy Bookzz',
                'beverages': 'Beverages',
                'cafespecials': 'Cafe Specials'
            };
            return categoryMap[category] || category;
        }

        const CATEGORY_ORDER = [
            "soup",
            "salads",
            "starter",
            "maincourses",
            "chefspecial",
            "asianmain",
            "asiannonveg",
            "asianveg",
            "kerala",
            "bread",
            "grill",
            "crispy",
            "beverages",
            "cafespecials"
        ];

        /**
         * Render a single menu item card
         */
        function renderItem(docSnap) {
            const item = docSnap.data();
            const id = docSnap.id;

            // Escape HTML to prevent XSS
            const escapedName = item.name.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const escapedPrice = item.price.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            return `
        <div class="menu-card" data-id="${id}">
          <div class="view-mode">
            <h3>${escapedName}</h3>
            <div class="menu-price">${escapedPrice}</div>
            <span class="menu-meta">${formatCategory(item.category)}</span>

            <div class="card-actions">
              <button class="edit-btn" onclick="enableEdit('${id}')" title="Edit this item">
                ‚úèÔ∏è Edit
              </button>
              <button class="delete-btn" onclick="deleteItem('${id}')" title="Delete this item">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>

          <div class="edit-mode" style="display:none">
            <input 
              type="text" 
              id="name-${id}" 
              value="${escapedName}" 
              placeholder="Item name"
              aria-label="Item name"
            >
            <input 
              type="text" 
              id="price-${id}" 
              value="${escapedPrice}" 
              placeholder="Price"
              aria-label="Price"
            >

            <div class="card-actions">
              <button class="save-btn" onclick="saveEdit('${id}')" title="Save changes">
                üíæ Save
              </button>
              <button class="cancel-btn" onclick="cancelEdit('${id}')" title="Cancel editing">
                ‚úñÔ∏è Cancel
              </button>
            </div>
          </div>
        </div>
      `;
        }

        /**
         * Render empty state when no items exist
         */
        function renderEmptyState() {
            return `
                <div class="empty-state">
                    <h3>üìã No menu items yet</h3>
                    <p>Add your first item using the form above to get started</p>
                </div>
            `;
        }

        // ============================================
        // AUTHENTICATION HANDLERS
        // ============================================

        /**
         * Handle user login
         */
        if (loginBtn) {
            loginBtn.addEventListener("click", async () => {
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                // Validate inputs
                if (!validateInput(email, 'Email')) return;
                if (!validateInput(password, 'Password')) return;

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showNotification('Please enter a valid email address', 'error');
                    return;
                }

                // Show loading state
                setButtonLoading(loginBtn, true, 'Login to Dashboard');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showNotification('‚úÖ Login successful! Welcome back.', 'success');
                } catch (err) {
                    console.error('Login error:', err);

                    // User-friendly error messages
                    let errorMessage = 'Login failed. Please try again.';

                    if (err.code === 'auth/invalid-credential') {
                        errorMessage = 'Invalid email or password';
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email';
                    } else if (err.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password';
                    } else if (err.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed attempts. Please try again later';
                    } else if (err.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Check your connection';
                    }

                    showNotification(errorMessage, 'error');
                } finally {
                    setButtonLoading(loginBtn, false, 'Login to Dashboard');
                }
            });

            // Allow Enter key to submit login
            [emailInput, passwordInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });
            });
        }

        /**
         * Handle user logout
         */
        if (logoutBtn) {
            logoutBtn.addEventListener("click", async () => {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await signOut(auth);
                        showNotification('üëã Logged out successfully', 'success');

                        // Clear input fields
                        emailInput.value = '';
                        passwordInput.value = '';
                    } catch (err) {
                        console.error("Logout error:", err);
                        showNotification('Logout failed. Please try again.', 'error');
                    }
                }
            });
        }

        // ============================================
        // ADD ITEM HANDLER
        // ============================================

        /**
         * Handle adding new menu item
         */
        if (addItemBtn) {
            addItemBtn.addEventListener("click", async () => {
                const name = nameInput.value.trim();
                const price = priceInput.value.trim();
                const category = categorySelect.value;

                // Validate inputs
                if (!validateInput(name, 'Item name')) {
                    nameInput.focus();
                    return;
                }

                if (!validateInput(price, 'Price')) {
                    priceInput.focus();
                    return;
                }

                // Show loading state
                setButtonLoading(addItemBtn, true, 'Add Item to Menu');

                try {
                    // Add item to Firestore with timestamp
                    await addDoc(collection(db, "menu_items"), {
                        name,
                        price,
                        category,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });

                    // Clear form
                    clearForm();

                    // Show success message
                    showNotification('‚úÖ Item added successfully!', 'success');

                    // Scroll to items section on mobile
                    if (window.innerWidth < 768) {
                        document.querySelector('.items-section').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                } catch (error) {
                    console.error("Error adding item:", error);

                    // User-friendly error message
                    let errorMessage = 'Failed to add item. Please try again.';

                    if (error.code === 'permission-denied') {
                        errorMessage = 'Permission denied. Please check your access rights.';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'Service unavailable. Check your connection.';
                    }

                    showNotification(errorMessage, 'error');
                } finally {
                    setButtonLoading(addItemBtn, false, 'Add Item to Menu');
                }
            });

            // Allow Enter key in name and price fields to add item
            [nameInput, priceInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addItemBtn.click();
                    }
                });
            });
        }

        // ============================================
        // AUTHENTICATION STATE MANAGEMENT
        // ============================================

        /**
         * Monitor authentication state changes
         * Shows/hides appropriate UI based on login status
         */
        onAuthStateChanged(auth, user => {
            if (user) {
                // Logged in
                loginBox.style.display = "none";
                adminPanel.style.display = "block";

                // Load initial data
                loadItems();            // Existing Menu Items
                loadDashboardGraph();   // Dashboard
                loadTodaySoldItems();   // Dashboard
                loadBillingItems();     // Billing Dropdown
                loadBills('7days');     // Bills History

                // Show default page
                showPage('dashboard');

                console.log('‚úÖ Logged in:', user.email);
            } else {
                // Logged out
                loginBox.style.display = "block";
                adminPanel.style.display = "none";

                // Clear any sensitive data
                if (itemsDiv) itemsDiv.innerHTML = '';

                console.log('üö™ Logged out');
            }
        });

        // ============================================
        // LOAD ITEMS FROM DATABASE
        // ============================================

        /**
         * Load and display all menu items with real-time updates
         * Items are sorted by creation date (newest first)
         */
        function loadItems() {
            const itemsRef = collection(db, "menu_items");

            onSnapshot(itemsRef, (snapshot) => {

                // 1Ô∏è‚É£ Create empty category buckets
                const grouped = {};
                CATEGORY_ORDER.forEach(cat => grouped[cat] = []);

                // 2Ô∏è‚É£ Push items into their category
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const category = item.category || "others";
                    if (!grouped[category]) grouped[category] = [];
                    grouped[category].push(docSnap);
                });

                // 3Ô∏è‚É£ Render category sections
                itemsDiv.innerHTML = "";

                CATEGORY_ORDER.forEach(category => {
                    const items = grouped[category];

                    itemsDiv.innerHTML += `
              <div class="category-block">
                <h4 class="category-heading">${formatCategory(category)}</h4>
                <div class="category-items">
                  ${items.length
                            ? items.map(renderItem).join("")
                            : `<p class="empty-category">No items in this category</p>`
                        }
                </div>
              </div>
            `;
                });

                console.log("üì¶ Categories rendered");

            }, error => {
                console.error(error);
                showNotification(error.message, "error");
            });
        }

        // ============================================
        // DASHBOARD LOGIC (PHASE 3-A)
        // ============================================

        const todayDate = new Date().toISOString().split("T")[0];
        const now = Date.now();
        const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);

        /**
         * Load Activity Graph (Last 7 Days)
         */
        function loadDashboardGraph() {
            const q = query(
                collection(db, "daily_sales"),
                where("lastUpdated", ">=", sevenDaysAgo),
                orderBy("lastUpdated", "asc")
            );

            onSnapshot(q, (snapshot) => {
                const graphData = [];
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    graphData.push({
                        date: d.date,
                        totalItems: d.totalItems || 0
                    });
                });

                console.log("üìä Graph data:", graphData);
                renderGraph(graphData);
            });
        }

        /**
         * Render Chart.js Graph
         */
        let activityChart;
        function renderGraph(graphData) {
            const ctx = document.getElementById("activityChart");
            if (!ctx) return;

            const labels = graphData.map(d => d.date);
            const values = graphData.map(d => d.totalItems);

            if (activityChart) activityChart.destroy();

            activityChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Items Sold",
                        data: values,
                        borderColor: "#667eea",
                        backgroundColor: "rgba(102,126,234,0.15)",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        /**
         * Load Today's Sold Items
         */
        function loadTodaySoldItems() {
            const q = query(
                collection(db, "today_items"),
                where("date", "==", todayDate)
            );

            onSnapshot(q, (snapshot) => {
                const todayList = [];
                snapshot.forEach(docSnap => {
                    todayList.push(docSnap.data());
                });

                // Sort: Highest qty first
                todayList.sort((a, b) => b.qty - a.qty);

                console.log("üìã Today sold:", todayList);
                renderTodayList(todayList);
            });
        }

        /**
         * Render Today's List
         */
        function renderTodayList(items) {
            const list = document.getElementById("todaySoldList");
            if (!list) return;

            list.innerHTML = "";

            if (items.length === 0) {
                list.innerHTML = "<li style='padding:15px;text-align:center;color:#999'>No sales today yet.</li>";
                return;
            }

            items.forEach(item => {
                list.innerHTML += `
                    <li style="display:flex;justify-content:space-between;padding:12px 0;">
                        <span>${item.name}</span>
                        <strong style="color:#667eea">${item.qty}</strong>
                    </li>
                `;
            });
        }

        // ============================================
        // NAVIGATION LOGIC (PHASE 3-D)
        // ============================================

        const pages = ["dashboard", "menu", "billing", "bills"];
        const navButtons = document.querySelectorAll(".nav-btn");

        function showPage(page) {
            pages.forEach(p => {
                const el = document.getElementById(p);
                if (el) el.style.display = p === page ? "block" : "none";
            });

            navButtons.forEach(btn => {
                btn.classList.toggle("active", btn.dataset.page === page);
            });
        }

        // Add Click Handlers
        navButtons.forEach(btn => {
            btn.onclick = () => showPage(btn.dataset.page);
        });

        // ============================================
        // BILLING LOGIC (PHASE 3-B)
        // ============================================

        let currentBill = [];

        /**
         * Load items into billing select
         */
        function loadBillingItems() {
            onSnapshot(collection(db, "menu_items"), snapshot => {
                const select = document.getElementById("billItem");
                if (!select) return;

                select.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    select.innerHTML += `<option value="${item.name}">${item.name}</option>`;
                });
            });
        }

        /**
         * Add Item to Bill
         */
        document.getElementById("addToBill").onclick = () => {
            const select = document.getElementById("billItem");
            const qtyInput = document.getElementById("billQty");

            const name = select.value;
            const qty = Number(qtyInput.value);

            if (!name) return;

            const existing = currentBill.find(i => i.name === name);
            if (existing) existing.qty += qty;
            else currentBill.push({ name, qty });

            // Reset qty
            qtyInput.value = 1;

            renderBill();
        };

        /**
         * Render Current Bill
         */
        function renderBill() {
            const list = document.getElementById("billList");
            const total = document.getElementById("totalItems");

            list.innerHTML = "";
            let sum = 0;

            currentBill.forEach((item, i) => {
                sum += item.qty;
                list.innerHTML += `
                <li>
                    <span>${item.name} <small style="color:#666">x ${item.qty}</small></span>
                    <button onclick="window.removeBillItem(${i})" style="background:none; border:none; color:red; cursor:pointer;">‚ùå</button>
                </li>
                `;
            });

            total.textContent = sum;
        }

        /**
         * Remove Item from Bill
         */
        window.removeBillItem = (index) => {
            currentBill.splice(index, 1);
            renderBill();
        }

        /**
         * Generate Unique Bill No
         */
        function generateBillNo() {
            const d = new Date();
            return `B-${d.getFullYear()}${d.getMonth() + 1}${d.getDate()}-${Date.now().toString().slice(-4)}`;
        }

        /**
         * UPDATE DASHBOARD (PHASE 3-A1)
         */
        async function updateDashboardAfterPayment(bill) {
            const dayRef = doc(db, "daily_sales", bill.date);

            // 1Ô∏è‚É£ Update DAILY SALES
            const totalQty = bill.items.reduce((sum, item) => sum + item.qty, 0);

            await setDoc(
                dayRef,
                {
                    date: bill.date,
                    totalItems: increment(totalQty),
                    lastUpdated: Date.now()
                },
                { merge: true }
            );

            // 2Ô∏è‚É£ Update TODAY ITEMS
            for (const item of bill.items) {
                // Creates a safe ID replacing spaces
                const safeId = item.name.replace(/\s+/g, "_");
                const itemRef = doc(db, "today_items", safeId);

                await setDoc(
                    itemRef,
                    {
                        name: item.name,
                        qty: increment(item.qty),
                        date: bill.date
                    },
                    { merge: true }
                );
            }
        }

        /**
         * PAY & PRINT
         */
        document.getElementById("payBill").onclick = async () => {
            const tableNo = document.getElementById("tableNo").value;

            if (!tableNo) {
                showNotification("Please enter Table Number", "error");
                return;
            }
            if (currentBill.length === 0) {
                showNotification("Bill is empty", "error");
                return;
            }

            if (!confirm("Confirm Payment & Print?")) return;

            setButtonLoading(document.getElementById("payBill"), true, "üí≥ PAY & PRINT");

            try {
                const bill = {
                    billNo: generateBillNo(),
                    tableNo: Number(tableNo),
                    date: todayDate,
                    timestamp: Date.now(),
                    items: currentBill,
                    total: currentBill.reduce((s, i) => s + i.qty, 0),
                    status: "PAID"
                };

                // 1. Save Bill
                await addDoc(collection(db, "bills"), bill);

                // 2. Update Dashboard Stats
                await updateDashboardAfterPayment(bill);

                showNotification("‚úÖ Bill PAID!", "success");

                // 3. Print
                window.print();

                // 4. Reset
                currentBill = [];
                renderBill();
                document.getElementById("tableNo").value = "";

            } catch (err) {
                console.error(err);
                showNotification("Error: " + err.message, "error");
            } finally {
                setButtonLoading(document.getElementById("payBill"), false, "üí≥ PAY & PRINT");
            }
        };

        // ============================================
        // BILLS HISTORY (PHASE 3-C & 3-H)
        // ============================================

        // const sevenDaysAgo is already defined in Dashboard Logic
        let allBills = []; // Cache for client-side filtering

        function loadBills(filter = '7days') {
            // Initial Load (Realtime)
            if (allBills.length === 0) {
                const billsRef = collection(db, "bills");
                const q = query(
                    billsRef,
                    where("timestamp", ">=", sevenDaysAgo),
                    orderBy("timestamp", "desc")
                );

                onSnapshot(q, snapshot => {
                    allBills = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderBills(filter);
                });
            } else {
                // Just filter existing data
                renderBills(filter);
            }
        }

        // Render with Filter
        function renderBills(filter) {
            const container = document.getElementById("billsList");
            if (!container) return;

            container.innerHTML = "";

            const filtered = allBills.filter(bill => {
                if (filter === "today") return isToday(bill.date);
                if (filter === "yesterday") return isYesterday(bill.date);
                return true; // 7days (default)
            });

            if (filtered.length === 0) {
                container.innerHTML = "<p style='color:#fff; text-align:center; padding:20px;'>No bills found.</p>";
                return;
            }

            filtered.forEach(b => {
                const totalItems = b.items ? b.items.reduce((s, i) => s + i.qty, 0) : 0;

                container.innerHTML += `
                    <div class="history-card">
                        <div class="bill-info">
                            <h4>#${b.billNo}</h4>
                            <div class="bill-meta">
                                Table ${b.tableNo} ‚Ä¢ ${b.date}
                            </div>
                        </div>
                        <div class="bill-actions">
                            <span style="font-weight:bold; margin-right:15px;">${totalItems} items</span>
                            <span class="status-tag" style="background:${b.status === 'PAID' ? '#d1fae5' : '#fee2e2'}; color:${b.status === 'PAID' ? '#047857' : '#b91c1c'}; padding:4px 8px; border-radius:4px; font-size:12px; margin-right:8px;">${b.status}</span>
                            <button class="print-btn" onclick="window.reprintBill('${b.id}')">üñ® Print</button>
                        </div>
                    </div>
                `;
            });
        }

        // Helpers
        function isToday(dateStr) {
            const today = new Date().toISOString().split("T")[0];
            return dateStr === today;
        }

        function isYesterday(dateStr) {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            return dateStr === d.toISOString().split("T")[0];
        }

        // Filter Change
        document.getElementById("billFilter").onchange = (e) => {
            renderBills(e.target.value);
        };

        // Reprint
        window.reprintBill = async (id) => {
            try {
                const docRef = doc(db, "bills", id);
                const snap = await getDoc(docRef);
                if (!snap.exists()) return;

                const bill = snap.data();

                let printContent = `
CHEFS CAFE - BILL COPY
Bill No: ${bill.billNo}
Table: ${bill.tableNo}
Date: ${bill.date}
------------------------
`;
                bill.items.forEach(i => {
                    printContent += `${i.name} x ${i.qty}\n`;
                });
                printContent += `------------------------
Total Qty: ${bill.total}
Status: RE-PRINT
`;

                const win = window.open("", "", "width=300,height=600");
                win.document.write(`<pre style="font-family:monospace">${printContent}</pre>`);
                win.document.close();
                win.focus();
                win.print();
                win.close();
            } catch (e) {
                console.error(e);
                alert("Error printing");
            }
        };

        // ============================================
        // INITIALIZATION COMPLETE
        // ============================================
        console.log('üöÄ Chef Cafe Admin Dashboard initialized');
    </script>
</body>

</html>